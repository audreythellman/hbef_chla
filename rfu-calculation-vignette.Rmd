---
title: "rfu-calculation-vignette"
author: "Audrey Thellman"
date: "8/31/2020"
output: rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

projdir <- getwd() #set project directory 

# add packages 

library(tidyverse)
library(lubridate)
library(readxl)

```

## Introduction

Coverting between chlorophyll-a (chl-a) raw units (rfu) and mg/m*\^2* for the Hubbard Brook Experimental Forest long-term algal record

To do this calculation, you need three five things: 

* The sample list file (sample ID, sampling date, substrate, and watershed, or weir)
* The raw chl-a units (rfu) file with: a) rfu, b) volume of etoh, c) sample ID, and d) chla run number
* The standard curve slope 
* The blanks measured for each run 
* the surface areas of the substrates

In general, the caclulation will first, merge the raw data with the sampling listing. Second, subtract average blank values from each run. Third, calculate chl-a in mg/m2 using the slope of the standard curve, the volume of EtOH, and the surface area of the substrates. 

## Step 1: clean and merge data 

First, load the data into your workspace

```{r load data}
rfu_data <- read.csv(paste0(projdir, "/raw data/hbef_chla_rfu.csv"))
samplinglist <- read.csv(paste0(projdir, "/raw data/samplinglist.csv"), skip = 1)
```

In the next steps, we will: 

1) check that your sample ID's match between `rfu_data` and `samplinglist` 
2) create factors for weir and substrate
3) assign a substrate code (see `substrate_surfaceareas.xlsx`)

```{r merge-prep data}

rfu_data[rfu_data$Sample.ID %in% samplinglist$Sample.ID == F,]
# if the data's sample ID's do not match, they will show up here on the rfu_data file, check for typos 

chla_data <- merge(rfu_data, samplinglist, by = "Sample.ID", all.x = T) #merge two dataframes by SampleID, keeping all of those values 

#create factors for weir and substrate 

chla_data$weir <- as.factor(substr(chla_data$WEIR.REP, 1,2))
chla_data$substrate <- as.factor(substr(chla_data$WEIR.REP,4,4))

#assign substrate code (NOTE ONLY FOR 2019+ SAMPLES)
chla_data$subs_code <- as.factor(ifelse(chla_data$substrate == "M", "M_b", "T"))

#only run for 2018 samples 
#chla_data$subs_code <- ifelse(chla_data$substrate == "M", "M_s", chla_data$substrate)

#change to date format 
chla_data$Date <- as.Date(chla_data$Date)

```
Now your data should have the required columns of a) rfu value, b) substrate, c) date, d) weir, and e) sampling ID which will give you substrate, date, and weir 

## Step 2: convert from rfu to mg/m^2

To covert from rfu to mg/m2 we use the following equation: 

$$RFU_{corrected} \cdot \frac {Slope}{1000} \cdot \frac {V_{EtOH}}{1000}\cdot \frac {1}{SA}$$
where $RFU$ is the raw units (corrected by substracting the average of the blanks), $Slope$ is the standard slope  ($\frac {rfu} {ug/L}$), $V$ is the volume of ethanol (mL) and $SA$ is the surface area ($m^2$). 

To do this calculation, we will source the function `rfu-to-mgm2-chla.R`

Please pay attention to formatting! The formatting of the sheet must be identical to this example for this function to work. 

```{r get function}
surfaceareas <- read_excel(path = paste0(projdir, "/raw data/substrate_surfaceareas.xlsx"), sheet = 1)
blanks_df <- read.csv(paste0(projdir, "/raw data/slope_and_blanks.csv"))[1:2]
slope <- as.numeric(read.csv(paste0(projdir, "/raw data/slope_and_blanks.csv"))[1,3])

source("rfu-to-mgm2-chla.R")

chla_data2 <- rfu_mgm2_chla(chla_df = chla_data, sa_df = surfaceareas, slp = slope, blank_df = blanks_df)

head(chla_data2) #view result data 
```

Now, we can save a "tidy" output version of this data, keeping only the parts that we need: 

``` {r save tidy data}
chla_data3 <- (chla_data2)[c(1,4,5,6,8,9,10,12)]

write.csv(chla_data3, row.names = F)

```
